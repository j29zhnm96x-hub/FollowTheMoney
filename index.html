<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FollowTheMoney</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FollowTheMoney">
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" sizes="180x180" href="img/favicon.png?v=2">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="180x180" href="img/favicon.png?v=2">
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app" class="app">
    <section id="screen-home" class="screen active" aria-label="Home">
      <header class="top-bar">
        <button id="btnHistory" class="pill accent" aria-label="History">History</button>
        <h1 class="logo">FollowTheMoney</h1>
        <button id="btnSettings" class="pill accent" aria-label="Settings">
          <svg class="icon-gear" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
            <path fill="#fff" d="M19.14 12.94c.04-.3.06-.61.06-.94s-.02-.64-.07-.94l2.03-1.58a.5.5 0 0 0 .12-.63l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.08 7.08 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 14.98 2h-3.96a.5.5 0 0 0-.5.42l-.36 2.54c-.59.24-1.13.55-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L3.62 8.48a.5.5 0 0 0 .12.63l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94L3.74 13.15a.5.5 0 0 0-.12.63l1.92 3.32c.13.23.4.32.63.22l2.39-.96c.5.4 1.04.71 1.63.94l.36 2.54c.04.25.25.42.5.42h3.96c.25 0 .46-.17.5-.42l.36-2.54c.59-.24 1.13-.55 1.63-.94l2.39.96c.23.1.5.01.63-.22l1.92-3.32a.5.5 0 0 0-.12-.63l-2.03-1.58zM12 15.5a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7z" />
          </svg>
        </button>
      </header>
      <main class="center-stack">
        <div class="balance-label">Balance <span id="seasonBadge" class="badge" hidden>Off-season</span></div>
        <div id="balance" class="balance" aria-label="Balance">0.00 €</div>
        <div id="dashboardGrid" class="dashboard-grid" hidden>
          <div class="dashboard-card" data-period="day">
            <div class="card-label">Daily</div>
            <div id="dailyAllowance" class="card-allowance">0.00 €</div>
            <div id="dailySpent" class="card-spent">0.00 €</div>
          </div>
          <div class="dashboard-card" data-period="week">
            <div class="card-label">Weekly</div>
            <div id="weeklyAllowance" class="card-allowance">0.00 €</div>
            <div id="weeklySpent" class="card-spent">0.00 €</div>
          </div>
          <div class="dashboard-card" data-period="month">
            <div class="card-label">Monthly</div>
            <div id="monthlyAllowance" class="card-allowance">0.00 €</div>
            <div id="monthlySpent" class="card-spent">0.00 €</div>
          </div>
        </div>
        <div id="recentList" class="recent-list" aria-label="Recent transactions"></div>
      </main>
      <div class="float-buttons">
        <button id="btnAddIncome" class="circle income" aria-label="Add income"></button>
        <button id="btnAddExpense" class="circle expense" aria-label="Add expense"></button>
      </div>
    </section>
    <section id="screen-history" class="screen" aria-label="History" hidden>
      <header class="top-bar">
        <button id="btnHome" class="pill accent" aria-label="Home">Home</button>
        <h1 class="logo">History</h1>
        <div class="pill ghost hidden-placeholder">•</div>
      </header>
      <div class="type-filter-card">
        <div id="historyTypeFilters" class="type-filters" role="group" aria-label="Type filters">
          <button class="type-pill" data-type="income">Income</button>
          <button class="type-pill" data-type="all">All</button>
          <button class="type-pill" data-type="expense">Expense</button>
        </div>
      </div>
      <div id="historyGroupSummary" class="group-summary" hidden></div>
      <div id="historyFilter" class="history-filter" hidden></div>
      <div class="chip-row" id="categoryChipRow" aria-label="Categories"></div>
      <div class="chip-row" id="nameChipRow" aria-label="Names"></div>
      <main class="history-list" id="historyList" aria-live="polite"></main>
    </section>
    <section id="screen-summary" class="screen" aria-label="Group summary" hidden>
      <header class="top-bar">
        <button id="btnSummaryBack" class="pill accent" aria-label="Back to history">Back</button>
        <h1 class="logo">Summary</h1>
        <div class="pill ghost hidden-placeholder">•</div>
      </header>
      <div class="summary-shell">
        <article class="summary-card" aria-live="polite">
          <p id="summaryLabel" class="summary-label">All entries</p>
          <div class="summary-total">
            <div>
              <span>Total balance</span>
              <strong id="summaryNet">0.00 €</strong>
            </div>
            <div>
              <span>Entries</span>
              <strong id="summaryCount">0</strong>
            </div>
          </div>
          <div class="summary-metrics">
            <div class="metric">
              <span>Average amount</span>
              <strong id="summaryAverage">0.00 €</strong>
            </div>
          </div>
          <p id="summaryFilters" class="summary-filters">No filters applied</p>
        </article>
        <section class="summary-list" aria-label="Preview transactions">
          <h2>Preview</h2>
          <p class="summary-hint">Swipe left on an entry to toggle whether it counts toward the average.</p>
          <div id="summaryList" class="summary-list-items"></div>
        </section>
      </div>
    </section>
    <section id="screen-graph" class="screen" aria-label="Insights" hidden>
      <header class="graph-top-bar" role="banner">
        <h1 class="graph-title" aria-label="Insights">Insights</h1>
        <div class="graph-toolbar">
          <button id="btnGraphTimeline" class="graph-icon-btn" type="button" aria-pressed="false" aria-label="Toggle timeline view">
            <svg viewBox="0 0 24 24" role="presentation" aria-hidden="true">
              <rect x="4" y="11" width="3" height="7" rx="1" />
              <rect x="9" y="8" width="3" height="10" rx="1" />
              <rect x="14" y="5" width="3" height="13" rx="1" />
              <rect x="19" y="3" width="3" height="15" rx="1" />
            </svg>
          </button>
          <div id="graphTypeFilters" class="graph-type-filters" role="group" aria-label="Graph Type">
            <button class="graph-type-pill" data-graph-type="income">Income</button>
            <button class="graph-type-pill" data-graph-type="expense">Expense</button>
          </div>
        </div>
        <div class="graph-view-toggle" role="radiogroup" aria-label="Group by">
          <label>
            <input type="radio" name="graphGroup" value="category" checked>
            <span>Categories</span>
          </label>
          <label>
            <input type="radio" name="graphGroup" value="name">
            <span>Names</span>
          </label>
        </div>
      </header>
      <div class="graph-board">
        <div class="graph-main" id="graphMain">
          <div class="graph-breakdown-card">
            <div class="graph-breakdown-header">
              <h2>Breakdown</h2>
            </div>
            <div class="graph-legend" id="graphLegend" aria-live="polite"></div>
          </div>
          <div class="graph-chart-card">
            <div class="graph-canvas-shell">
              <div class="graph-total-overlay">
                <p class="total-label">Total</p>
                <p id="graphTotalValue" class="total-amount">0.00 €</p>
                <p id="graphTotalScope" class="total-scope">Income · by categories</p>
              </div>
              <div class="graph-canvas-wrap">
                <canvas id="graphCanvas" width="340" height="340" aria-label="Distribution chart"></canvas>
                <div id="graphEmpty" class="graph-empty" hidden>No data to visualize yet.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="graph-timeline" id="graphTimeline" hidden>
          <div class="graph-timeline-card">
            <header class="timeline-header">
              <div>
                <h2>Timeline</h2>
                <p class="timeline-subtitle">Income vs Expense over time</p>
              </div>
              <div class="timeline-legend">
                <span><span class="dot income"></span> Income</span>
                <span><span class="dot expense"></span> Expense</span>
              </div>
            </header>
            <div class="timeline-canvas-wrap" id="timelineCanvasWrap">
              <canvas id="timelineCanvas" width="720" height="360" aria-label="Timeline chart"></canvas>
              <div id="timelineEmpty" class="timeline-empty" hidden>Need at least two days of data to draw trends.</div>
              <div id="timelineCursor" class="timeline-cursor" hidden aria-hidden="true"></div>
              <div id="timelineCursorPopup" class="timeline-popup" hidden aria-live="polite">
                <p id="timelinePopupDate" class="timeline-popup-date"></p>
                <ul id="timelinePopupList" class="timeline-popup-list"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <div id="settingsModal" class="modal" hidden>
      <div class="modal-overlay" data-dismiss></div>
      <div class="modal-panel" role="dialog" aria-modal="true" aria-label="Settings">
        <div class="settings-header">
          <div class="settings-title" aria-label="Settings">
            <span class="settings-gear" aria-hidden="true">⚙</span>
            <h2>Settings</h2>
          </div>
          <label class="toggle-row switch inline-switch">
            <input type="checkbox" id="themeToggle">
            <span class="switch-ui" aria-hidden="true"><span class="switch-thumb"></span></span>
            <span class="theme-label">Light</span>
          </label>
        </div>
        <div class="settings-body">
          <div class="settings-grid">
            <section class="settings-card" aria-labelledby="generalHeading">
              <div>
                <h3 id="generalHeading">General</h3>
                <p class="card-subtitle">Choose how dates appear across the app.</p>
              </div>
              <div class="setting-row">
                <label for="dateFormat" class="small-label">Date format</label>
                <select id="dateFormat" class="text-input select-input">
                  <option value="dmy">Day / Month / Year</option>
                  <option value="mdy">Month / Day / Year</option>
                  <option value="ymd">Year / Month / Day</option>
                </select>
                <div class="preview small">Applies to recent cards and history.</div>
              </div>
              <div class="setting-row">
                <label for="currencySymbol" class="small-label">Currency symbol</label>
                <input id="currencySymbol" type="text" class="text-input" maxlength="3" placeholder="€" />
                <div class="preview small">Shown after every amount (e.g. €, $, Kč).</div>
              </div>
            </section>
            <section class="settings-card" aria-labelledby="seasonHeading">
              <div>
                <h3 id="seasonHeading">Seasonal Budget</h3>
                <p class="card-subtitle">Set the working season so the app can guide off-season spending.</p>
              </div>
              <div class="setting-row">
                <label for="seasonStart" class="small-label">Start of working season</label>
                <input id="seasonStart" type="date" class="text-input date-compact" />
              </div>
              <div class="setting-row">
                <label for="seasonEnd" class="small-label">End of working season</label>
                <input id="seasonEnd" type="date" class="text-input date-compact" />
              </div>
              <button id="saveSeason" class="btn accent" disabled>Save Season Dates</button>
              <div class="setting-row">
                <div id="seasonInfo" class="preview small"></div>
                <div id="allowanceInfo" class="preview small"></div>
              </div>
            </section>
            <section class="settings-card" aria-labelledby="privacyHeading">
              <div>
                <h3 id="privacyHeading">History lock</h3>
                <p class="card-subtitle">Prevent accidental swipes from deleting entries.</p>
              </div>
              <label class="toggle-row switch">
                <input type="checkbox" id="historyLockToggle">
                <span class="switch-ui" aria-hidden="true"><span class="switch-thumb"></span></span>
                <span>Lock swipe-to-delete</span>
              </label>
              <div class="preview small">You can still edit entries using the pencil icon.</div>
            </section>
            <section class="settings-card" aria-labelledby="dataHeading">
              <div>
                <h3 id="dataHeading">Data export & import</h3>
                <p class="card-subtitle">Back up everything and move between devices.</p>
              </div>
              <div class="setting-row">
                <button id="btnExportShare" class="btn accent full">Share backup</button>
                <div class="preview small">Uses the OS share sheet when available.</div>
              </div>
              <div class="setting-row">
                <button id="btnExportEmail" class="btn ghost full">Email backup</button>
                <div class="preview small">Copies the backup and opens your mail app.</div>
              </div>
              <div class="setting-row">
                <button id="btnImportData" class="btn ghost full">Import backup</button>
                <div class="preview small">Select a saved .json backup file to restore.</div>
                <input id="importFile" type="file" accept="application/json" hidden />
              </div>
            </section>
            <section class="settings-card" aria-labelledby="advancedHeading">
              <div>
                <h3 id="advancedHeading">Advanced</h3>
                <p class="card-subtitle">Reset the app if you need a clean slate.</p>
              </div>
              <div class="advanced-group">
                <button id="btnClearAll" class="btn danger">Clear All Data</button>
                <div class="preview small">Clears all transactions and resets settings. A confirmation will appear when you press the button.</div>
              </div>
            </section>
          </div>
          <div class="settings-actions">
            <button id="btnHelpManual" class="btn accent full" type="button">Help &amp; Manual</button>
            <button class="btn ghost full" data-dismiss>Close</button>
          </div>
        </div>
      </div>
    </div>
    <div id="helpModal" class="modal" hidden>
      <div class="modal-overlay" data-dismiss></div>
      <div class="modal-panel help-panel" role="dialog" aria-modal="true" aria-label="Help and Manual">
        <div class="settings-header">
          <div class="settings-title">
            <span class="settings-gear" aria-hidden="true">❓</span>
            <h2>User Manual</h2>
          </div>
          <button class="btn ghost" data-dismiss aria-label="Close help">Close</button>
        </div>
        <div class="help-content" aria-live="polite">
          <section>
            <h3>Overview</h3>
            <p>FollowTheMoney is a compact, privacy-first money tracking app focused on simple entry, quick review, and clear visual insights. It supports income and expense recording, history browsing with filters, and a donut-style Insights view for high-level breakdowns.</p>
          </section>

          <section>
            <h3>Quick Start</h3>
            <ol>
              <li>Open the app and tap the green <em>Add Income</em> or red <em>Add Expense</em> circle on the Home screen.</li>
              <li>Enter the amount using the numeric keypad. Amounts are stored as cents (two decimals) and will display using your chosen currency symbol.</li>
              <li>Choose or type a <strong>Category</strong> (required) and a <strong>Name</strong> (optional but recommended) to group and attribute the transaction.</li>
              <li>Optionally add a note or change the transaction date/time when editing.</li>
              <li>Tap <em>Add</em> (or <em>Save Changes</em> when editing) to persist the transaction.</li>
            </ol>
          </section>

          <section>
            <h3>Screens & Controls</h3>
            <h4>Home</h4>
            <p>Shows your current balance, three allowance cards (daily/weekly/monthly when relevant), and the most recent transactions. Use the floating add buttons to create new entries quickly.</p>

            <h4>History</h4>
            <ul>
              <li><strong>Type filters:</strong> Use the Income/All/Expense pills to limit visible items by transaction sign.</li>
              <li><strong>Chip rows:</strong> Category and Name chips appear below the filters. Tap a chip to limit History to that value. Use the pill labeled <em>All</em> to clear.</li>
              <li><strong>Group summary:</strong> A summary card shows totals for the current filter set.</li>
              <li><strong>Edit & Delete:</strong> Tap the pencil icon on a transaction to edit. Swipe left/right to delete (swipe disabled when History Lock is on).</li>
            </ul>

            <h4>Insights</h4>
            <p>Best viewed in landscape: the screen is split into two cards. The left card lists a <strong>Breakdown</strong> (legend and top contributors). The right card shows a donut chart representing shared percentages. Controls at the top choose between Income vs Expense and grouping by Categories or Names.</p>
          </section>

          <section>
            <h3>Adding & Editing Transactions (Detailed)</h3>
            <p>When creating or editing an entry, these fields are available:</p>
            <ul>
              <li><strong>Amount</strong> — numeric keypad accepts digits; internal storage uses cents.</li>
              <li><strong>Category</strong> — required. Categories are used for grouping in Insights and History.</li>
              <li><strong>Name</strong> — optional. Helps attribute recurring sources or payees.</li>
              <li><strong>Note</strong> — optional free-text for context.</li>
              <li><strong>Date/Time</strong> — editable when modifying a transaction to backdate entries.</li>
            </ul>
          </section>

          <section>
            <h3>Insights: How the Donut Works</h3>
            <ul>
              <li>The chart draws only the currently selected sign: Income or Expense. If there are no entries for the selected sign, the app automatically switches to whichever has data.</li>
              <li>Each segment maps to a Category or Name (based on grouping). Segment colors are derived deterministically from the label.</li>
              <li>The left breakdown card lists contributors with percent values and absolute numbers to help you spot top items quickly.</li>
              <li>The center overlay shows the total and a short scope label (e.g., "Expense · by categories").</li>
            </ul>
          </section>

          <section>
            <h3>Seasonal Budgeting</h3>
            <p>Designed for seasonal work: set a working season in Settings to enable off-season behavior. When off-season, the app exposes allowance cards and shows an Off-season badge so you can budget spending conservatively.</p>
          </section>

          <section>
            <h3>Backups, Exports & Imports</h3>
            <ul>
              <li><strong>Share backup:</strong> Produces a JSON snapshot you can share via the OS share sheet.</li>
              <li><strong>Email backup:</strong> Copies the JSON to your clipboard and opens your mail app for manual sending.</li>
              <li><strong>Import backup:</strong> Replaces local data with the selected JSON snapshot. Always export a backup before importing to avoid accidental loss.</li>
              <li>Local snapshots are saved automatically and kept in browser storage as a fail-safe until overwritten by new changes.</li>
            </ul>
          </section>

          <section>
            <h3>Settings & Personalization</h3>
            <ul>
              <li><strong>Theme:</strong> Toggle Light/Dark themes for improved readability in different environments.</li>
              <li><strong>Date format:</strong> Choose how dates appear across History and Recent lists.</li>
              <li><strong>Currency symbol:</strong> Set the symbol displayed after amounts.</li>
              <li><strong>History Lock:</strong> Prevents accidental swipe-to-delete but still allows edits.</li>
            </ul>
          </section>

          <section>
            <h3>Troubleshooting & FAQs</h3>
            <dl>
              <dt>Q: The donut shows "No data to visualize yet" but I have transactions.</dt>
              <dd>A: Make sure you've selected the correct side (Income vs Expense) and grouping. The app will auto-switch if the opposite side has data, but if your transactions are zero-valued or all filtered out they will not render.</dd>
              <dt>Q: I imported a backup but don't see my data.</dt>
              <dd>A: After import, try reloading the app. Also ensure the import file was a valid JSON snapshot created by the app's export flow.</dd>
              <dt>Q: How do I preserve privacy?</dt>
              <dd>A: All data is stored locally (IndexedDB and localStorage). Exported backups are JSON files you control. Do not share backups publicly if they contain sensitive details.</dd>
            </dl>
          </section>

          <section>
            <h3>Accessibility</h3>
            <ul>
              <li>Controls use large touch targets and high-contrast pills. Toggle the Light theme for higher contrast if needed.</li>
              <li>The History list and graph legend use semantic roles and aria-live regions to announce changes where appropriate.</li>
              <li>Keyboard users can use Tab to focus buttons; press Escape to close modals.</li>
            </ul>
          </section>

          <section>
            <h3>Advanced / Developer Notes</h3>
            <ul>
              <li>Transactions stored with structure: { id, amountCents, createdAt, name, category, note, recurring }.</li>
              <li>Graph colors are derived from a small deterministic palette based on label hashing.</li>
              <li>Service worker caches application shell; a local backup flag may prompt updates when a new service worker is installed.</li>
            </ul>
          </section>

          <section>
            <h3>Contact & Support</h3>
            <p>If you still need help, export a backup via Settings → Share backup and provide it to support along with a description of the issue. Avoid sharing sensitive notes or personal data.</p>
          </section>
        </div>
      </div>
    </div>
    <div id="sheet" class="sheet" hidden>
      <div class="sheet-overlay" data-dismiss></div>
      <div class="sheet-panel" aria-label="Amount entry" role="dialog">
        <div class="sheet-grabber"></div>
        <div id="sheetAmount" class="amount-display">0.00 €</div>
        <input id="rawDigits" type="tel" inputmode="numeric" class="hidden-input" />
        <div id="categoryContainer" class="category-container" hidden>
          <label for="categoryInput" class="small-label">Category</label>
          <input id="categoryInput" type="text" class="text-input" list="categoryList" placeholder="Select or type category" autocomplete="off" />
          <datalist id="categoryList"></datalist>
          <div id="categorySuggestions" class="suggestion-row" hidden></div>
        </div>
        <div id="nameContainer" class="name-container" hidden>
          <label for="nameInput" class="small-label">Name</label>
          <input id="nameInput" type="text" class="text-input" list="nameList" placeholder="Name" autocomplete="off" disabled />
          <datalist id="nameList"></datalist>
          <div id="nameSuggestions" class="suggestion-row" hidden></div>
        </div>
        <div id="noteContainer" class="note-container" hidden>
          <textarea id="noteInput" placeholder="Note (optional)"></textarea>
        </div>
        <button id="toggleNote" class="btn ghost full">Add note</button>
        <div id="editDateContainer" class="date-edit" hidden>
          <label for="editDateInput" class="small-label">Transaction date & time</label>
          <input id="editDateInput" type="datetime-local" class="text-input" />
          <div class="preview small">Adjust this when editing to backdate entries.</div>
        </div>
        <button id="confirmBtn" class="btn primary full" disabled>Add</button>
      </div>
    </div>
  </div>
  <script src="seasonal.js" defer></script>
  <script src="app.js" defer></script>
</body>
</html>
